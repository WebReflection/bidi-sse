/*! (c) Andrea Giammarchi - ISC */
const t=new WeakMap;class e{constructor(){t.set(this,new Map)}on(e,s){const n=t.get(this);return n.has(e)||n.set(e,new Set),n.get(e).add(s),this}emit(e,...s){const n=t.get(this);if(n.has(e))for(const t of n.get(e))t.apply(this,s)}}const s=new WeakMap,n=t=>t.text();class r extends((t=>class extends t{static get CONNECTING(){return 0}static get OPEN(){return 1}static get CLOSING(){return 2}static get CLOSED(){return 3}})
/*! (c) Andrea Giammarchi - ISC */(e)){constructor(t,e={}){super();const n=e.fetch||{},r=new EventSource(t,{withCredentials:"omit"!==n.credentials}),{parse:i,stringify:a}=e.JSON||JSON,o={es:r,stringify:a,href:"",options:n,state:0};r.addEventListener("bidi-sse",(({data:t})=>{const e=i(t),s=new URL(r.url);s.searchParams.append("bidi-sse",e),o.href=s.href,o.state=1,this.emit("open")}),{once:!0}),r.addEventListener("unexpected",(({data:t})=>{this.emit("error",new Error("Unexpected ➡ "+i(t)))})),r.addEventListener("message",(({data:t})=>{this.emit("message",i(t))})),r.addEventListener("error",(()=>{o.state=2,this.emit("error",new Error("Connection lost ➡ "+t)),this.close()}),{once:!0}),r.addEventListener("close",(()=>{o.state=3,r.close(),this.emit("close")}),{once:!0}),s.set(this,o)}get readyState(){return s.get(this).state}send(t){const{stringify:e,href:r,options:i,state:a}=s.get(this);if(1!==a)throw new Error("invalid state");const o=e(t);fetch(r,{...i,method:"post",body:o}).then(n)}close(){s.get(this).es.dispatchEvent(new Event("close"))}}export{r as default};
