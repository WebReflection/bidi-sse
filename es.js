const e=new WeakMap;
/*! (c) Andrea Giammarchi - ISC */
const t=new WeakMap,s=e=>e.text();class r extends class{constructor(){e.set(this,new Map)}on(t,s){const r=e.get(this);return r.has(t)||r.set(t,new Set),r.get(t).add(s),this}emit(t,...s){const r=e.get(this);if(r.has(t))for(const e of r.get(t))e.apply(this,s)}}{static get CONNECTING(){return 0}static get OPEN(){return 1}static get CLOSING(){return 2}static get CLOSED(){return 3}get readyState(){return t.get(this).readyState}constructor(e,s={}){super();const r=s.fetch||{},n=new EventSource(e,{withCredentials:"omit"!==r.credentials}),{parse:a,stringify:i}=s.JSON||JSON,o={es:n,parse:a,stringify:i,options:r,href:"",readyState:0};n.addEventListener("id",(({data:e})=>{const t=a(e),s=new URL(n.url);s.searchParams.append("id",t),o.href=s.href,o.readyState=1,this.emit("open")}),{once:!0}),n.addEventListener("unexpected",(({data:e})=>{this.emit("error",new Error("Unexpected ➡ "+a(e)))})),n.addEventListener("message",(({data:e})=>{this.emit("message",a(e))})),n.addEventListener("error",(()=>{o.readyState=2,this.emit("error",new Error("Connection lost ➡ "+e)),this.close()}),{once:!0}),n.addEventListener("close",(()=>{o.readyState=3,n.close(),this.emit("close")}),{once:!0}),t.set(this,o)}send(e){const{href:r,options:n,readyState:a,stringify:i}=t.get(this);if(1!==a)throw new Error("invalid state");const o=i(e);fetch(r,{...n,method:"post",body:o}).then(s)}close(){t.get(this).es.dispatchEvent(new Event("close"))}}export{r as default};
